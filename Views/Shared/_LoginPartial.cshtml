@using Microsoft.AspNetCore.Identity
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject Townsquare.Data.ApplicationDbContext Db


@{
    var currentController = ViewContext.RouteData.Values["controller"]?.ToString();
    var currentAction = ViewContext.RouteData.Values["action"]?.ToString();

    bool isAdmin = false;

    if (SignInManager.IsSignedIn(User))
    {
        var currentUser = await UserManager.GetUserAsync(User);
        if (currentUser != null)
        {
            isAdmin = await UserManager.IsInRoleAsync(currentUser, "Admin");
        }
    }
}


@if (SignInManager.IsSignedIn(User))
{
    <nav class="ts-menu">
        <div class="ts-menu-pages">
            <a asp-controller="Home" asp-action="Index"
               class="@(currentController == "Home" && currentAction == "Index" ? "active" : "")">
                Home
            </a>

            <a asp-controller="Event" asp-action="MyEvents"
               class="@(currentController == "Event" && currentAction == "MyEvents" ? "active" : "")">
                My Events
            </a>
            
            @if (isAdmin)
            {
                <a asp-controller="Admin" asp-action="Users"
                   class="@(currentController == "Admin" ? "active" : "")">
                    Users
                </a>
            }
        </div>
      

        <a asp-controller="Notification" asp-action="Index" class="ts-icon-btn notification-wrapper">
            <img src="~/icons/bell.svg" alt="Notifications"/>

            @if (SignInManager.IsSignedIn(User))
            {
                var userId = UserManager.GetUserId(User);
                var unread = Db.Notifications.Count(n => !n.IsRead && n.UserId == userId);

                if (unread > 0)
                {
                    <span class="notification-badge">@unread</span>
                }
            }
        </a>

        <a asp-area="Identity" asp-page="/Account/Manage/Index" class="ts-icon-btn ts-profile-btn">
            <img src="~/icons/user.svg" alt="Profile"/>
        </a>

        <form asp-area="Identity" asp-page="/Account/Logout"
              asp-route-returnUrl="@Url.Action("Index", "Home")">
            <button type="submit" class="logout-btn">Logout</button>
        </form>
    </nav>
}
else
{
    <nav class="ts-menu">
        <a asp-area="Identity" asp-page="/Account/Login" class="login-btn">Login</a>
        <a asp-area="Identity" asp-page="/Account/Register" class="signup-btn">Sign Up</a>
    </nav>
}